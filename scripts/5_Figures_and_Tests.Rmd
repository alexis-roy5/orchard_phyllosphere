---
title: "Fungi_ITS_2023"
output: 
  html_document:
    toc: true
    toc_float: true
    toc_collapsed: true
    toc_depth: 3
    number_sections: false
    theme: lumen
date: "2025-04-07"
editor_options: 
  chunk_output_type: console
---

This is a script to produced the figures presented in (REFERENCES) starting from a phyloseq object

# Getting ready

## Load packages
```{r}
library(pacman)
p_load(phyloseq, tidyverse, vegan, patchwork, DESeq2, rstatix, ggpubr, ggrain, see, ggh4x)
```

## Import phyloseq object
```{r}
# Import phyloseq object (which is already an R object)
ps <- readRDS("~/USherbrooke/Isabelle Laforest-Lapointe - BOUTIN_Sophie/PROJECT/MICROBIAL_ECOLOGY/VERGER_ITS_2023/Data/ps_ITS_rarefied.rds")

# Verify dimensions 
dim(sample_data(ps))#329 15
dim(otu_table(ps)) #329 2795 (old = 2810)
dim(tax_table(ps)) #2795 7 (old = 2810)

# Transform "time" and "practice" variables into factors
sample_data(ps)$time <- factor(sample_data(ps)$time, levels = c("May", "July","August"))
sample_data(ps)$practice <- factor(sample_data(ps)$practice, levels = c("Conventional", "Organic"))

#RAREFACTION
# Rarefy all to 2500
min(sample_sums(otu_table(ps))) # 2500
# already rarefied to 2500

#ps.rarefied <-  rarefy_even_depth(ps, rngseed=1, sample.size=2500, replace=F)
# Verify new dimensions of phyloseq object
#dim(sample_data(ps.rarefied))#329 15
#dim(otu_table(ps.rarefied)) #329 2786
#dim(tax_table(ps.rarefied)) #2786 7
```

## Subset phyloseq object
For analyses we will need different subsets of the main phyloseq object
```{r}
# Leaf samples only (all time and all cultivar)
sub1 <- subset_samples(ps, type == "Leaf")

# Leaf samples (Spartan and Honeycrisp only)
sub2 <- subset_samples(sub1, cultivar == "Spartan"| cultivar == "Honeycrisp")
# May (Spartan and Honeycrisp only)
sub3 <- subset_samples(sub2, time == "May")
# July (Spartan and Honeycrisp only)
sub4 <- subset_samples(sub2, time == "July")
# August (Spartan and Honeycrisp only)
sub5 <- subset_samples(sub2, time == "August")

# All cultivars (leaf)
sub6 <- subset_samples(sub1, time == "May")
sub7 <- subset_samples(sub1, time == "July")
sub8 <- subset_samples(sub1, time == "August")

# Flower sample only (all cultivar)
sub9 <- subset_samples(ps, type == "Flower")

# Flower sample (HC + SP)
sub10 <- subset_samples(sub9, cultivar == "Spartan"| cultivar == "Honeycrisp")
# remove one sample from Cidrerie Compton because it is the only one at that site
sub10 <- subset_samples(sub10, code == "A" | code == "B1" | code == "C")

```

# Create functions
## Function with time
Create a function that generates PCoA dataframe, eigen values, and permanova results (input is the phyloseq object)
```{r}
# Name the function "df.func" and its input (a subset of the main phyloseq object)
df.func <- function(sub){
# Phyloseq variance stabilizing transformation with blind transformation
dds<-phyloseq_to_deseq2(sub,~practice) 
# Create function for computation (taken from online website of phyloseq)
gm_mean <- function(x, na.rm=TRUE){
  exp(sum(log(x[x > 0]), na.rm=na.rm) / length(x))}
# Estimate factor size
dds = estimateSizeFactors(dds, geoMeans = apply(counts(dds), 1, gm_mean))
# Blind version for all treatments
blind <- DESeq2::varianceStabilizingTransformation(dds, blind=T)
# Extract transformed asv table
mat <- SummarizedExperiment::assay(blind) 
# Transpose matrix
mat<-t(mat)
# Set values <0 to 0
mat[which(mat<0)]<-0  
# Compute the dissimilarity matrix (Bray-Curtis) 
dis.mx <- vegan::vegdist(mat, method = "bray")
# Ordination (multidimentional scaling) 
PCOA <- capscale(dis.mx~1, distance = "bray")
# Extract eigen values
eig <- round(PCOA$CA$eig[1:3]/sum(PCOA$CA$eig), 2) 
# Prepare a dataframe to plot
# Extract sample_data
pcoa.df <- data.frame(sample_data(sub))
# Create a PCo1 column
pcoa.df$PCo1 <- scores(PCOA)$sites[,1]
# Create a PCo2 column
pcoa.df$PCo2 <- scores(PCOA)$sites[,2]
# Number of permutation
perm <- with(pcoa.df, how(nperm=999, blocks = TreeID)) 
# Perform permanova
adonis.results <- adonis2(mat ~ (practice/site)*time+(practice/site)*cultivar, #site is nested within practice
        data = data.frame(pcoa.df),
        permutations = perm, method="bray") 
# Extract permutation results in a data frame
adonis.df <- as.data.frame(adonis.results)
# Return wanted results
return(list(res1=eig, res2 = pcoa.df, res3 = dis.mx, res4 = adonis.df))
}
```

## Function without time
Create the same function without the "time" variable in the permanova formula
```{r}
func.notime <- function(sub){
dds<-phyloseq_to_deseq2(sub,~practice) 
gm_mean <- function(x, na.rm=TRUE){
  exp(sum(log(x[x > 0]), na.rm=na.rm) / length(x))}
dds = estimateSizeFactors(dds, geoMeans = apply(counts(dds), 1, gm_mean))
blind <- DESeq2::varianceStabilizingTransformation(dds, blind=T)
mat <- SummarizedExperiment::assay(blind) 
mat<-t(mat)
mat[which(mat<0)]<-0  
dis.mx <- vegan::vegdist(mat, method = "bray")
PCOA <- capscale(dis.mx~1, distance = "bray")
eig <- round(PCOA$CA$eig[1:3]/sum(PCOA$CA$eig), 2) 
pcoa.df <- data.frame(sample_data(sub))
pcoa.df$PCo1 <- scores(PCOA)$sites[,1]
pcoa.df$PCo2 <- scores(PCOA)$sites[,2]
adonis.results <- adonis2(mat ~ (practice/site)*cultivar, 
        data = data.frame(pcoa.df),
        permutations = 999, method="bray") 
adonis.df <- as.data.frame(adonis.results)
return(list(res1=eig, res2 = pcoa.df, res3 = dis.mx, res4 = adonis.df))
}
```

## Apply functions
Apple the above functions to the desired data subsets
```{r}
# All leaf
app1 <- df.func(sub1) # Save function results into an object
eig1 <- app1$res1 # Extract eigen values
pcoa.df.1 <- app1$res2 # Extract pcoa data frame
mat1 <- app1$res3 # Dissimilarity matrix
ado1 <- app1$res4 # Extract permanova results
meta1 <- as.data.frame(sub1@sam_data) # Metadata

# Do the same for other data sets

# All flower
app9 <- func.notime(sub9)
eig9 <- app9$res1
pcoa.df.9 <- app9$res2
mat9 <- app9$res3
ado9 <- app9$res4
meta9 <- as.data.frame(sub9@sam_data)

# Leaf (MAY)
app6 <- func.notime(sub6)
eig6 <- app6$res1
pcoa.df.6 <- app6$res2
mat6 <- app6$res3
ado6 <- app6$res4
meta6 <- sub6@sam_data
# Leaf (JULY)
app7 <- func.notime(sub7)
eig7 <- app7$res1
pcoa.df.7 <- app7$res2
mat7 <- app7$res3
ado7 <- app7$res4
meta7 <- sub7@sam_data
# Leaf (AUGUST)
app8 <- func.notime(sub8)
eig8 <- app8$res1
pcoa.df.8 <- app8$res2
mat8 <- app8$res3
ado8 <- app8$res4
meta8 <- sub8@sam_data
```


# FIGURE 1 (Flowers)

## Figure 1A (PCoA)
```{r}

length(which(pcoa.df.9$practice=="Organic"))
length(which(pcoa.df.9$practice=="Conventional"))

(plot9 <- pcoa.df.9 %>% 
  ggplot(aes(x = PCo1, y = PCo2, colour = practice, shape = code, fill = practice, size = code)) +
  geom_point(size = 2.5) +
  theme_bw()+
  stat_ellipse(level=0.95, geom = "polygon",alpha = 1/6, aes(group = practice))+
  labs(x = paste("PCo1:", 100*eig9[1], "%"),
       y = paste("PCo2:", 100*eig9[2], "%"))+
  scale_color_manual(values= c("black","black"))+
  scale_shape_manual(name = "Sites", values = c(21,22,23,24))+
  scale_size_manual(values=c(3,3,3,3))+ 
  scale_fill_manual(name = "Practices", values = c("#F28E2B", "#499894"))+
  theme(legend.position = c(1, 1),
        legend.justification = c(1, 1),
        legend.direction = "horizontal",
        legend.background = element_rect(fill="white",
                                  size=0.5, linetype="solid", 
                                  colour ="black"),
        axis.title = element_text(size = 16))+
  guides(shape = guide_legend(override.aes = list(size=3)))+
  guides(fill = guide_legend(override.aes = list(shape = 22, size=3)))+
  guides(size = "none")+
  guides(color = "none"))
```

## Figure 2C (Abundance)
```{r}
# From a phyloseq object, find the top N abundant species, aggregate
# the others into an "Others" category and produce a bar_plot showing
# the average relative abundance of samples per metadata.

# This code uses relative abundances per sample, otherwise the aggregation
# of abundances is biased by the difference in the number of total sequences 
# per sample. 

topN <- 20 # <<< how many top taxa
taxRank <- 'Genus' # <<< which taxonomic rank 

# Melt the phyloseq object, agglomerate taxonomy and standardize abundances
ps.melt <- sub9 %>% # <<< !! your phyloseq object
  tax_glom(taxRank) %>% # aggregate at desired taxrank
  transform_sample_counts(function(x) x/sum(x)) %>%  # normalise counts to 1 by sample
  psmelt %>% # melt the object in a single (massive) table
  select(!!sym(taxRank), Abundance, # psmelt creates an Abundance variable
         practice, Sample) # <<< !! sample data variables you will need

# Change "Dothidotthiaceae_gen_Incertae_sedis" name
ps.melt$Genus[ps.melt$Genus == "Dothidotthiaceae_gen_Incertae_sedis"] <- "Dothidotthiaceae*"

# Create a taxon -> taxon group conversion table
taxonomie_agregee <- ps.melt %>% 
  group_by(!!sym(taxRank)) %>% # mean relative abundance by taxRank:
  summarise(sum_relab = mean(Abundance)) %>% 
  arrange(desc(sum_relab)) %>%          # most abundant first 
  mutate(aggTaxo = as.factor(case_when( # new aggregated taxonomy variable
    row_number() < topN ~ !!sym(taxRank),        # N-1 first keep their taxonomy
    row_number() >= topN ~ 'Others'))) %>% # 'Others' for every other taxa
  select(-sum_relab) # no need for this

# Reorder the vector so that 'Others' is first in plots
taxLvl <- taxonomie_agregee %$% aggTaxo %>% 
  setdiff(., 'Others') %>% # remove Others
  rev() %>%
  c('Others',.) # put Others first 

# add the aggregated taxonomy variable to the raw data
ps.melt_agg <- left_join(ps.melt, taxonomie_agregee, 
                         by = taxRank) %>% 
  mutate(aggTaxo = factor(aggTaxo, levels = taxLvl))%>% # reorder factor levels
  group_by(aggTaxo, practice, Sample) %>% # sum all Others into one by sample
  summarise(Abundance = sum(Abundance)) 

# simple stacked barplot :
b <- ps.melt_agg %>% 
  ggplot(aes(x = 1, y = Abundance, fill = aggTaxo)) +
  geom_bar(stat = 'identity', 
           position = 'fill')+
  facet_grid(~practice)+
  scale_fill_manual(values=c(
"#A6A6A9",
"#244154",
"#4E79A7",
"#A0CBE8",
"#F28E2B",
"#FC8D59",
"#FFBE7D",
"#B6992D",
"#F1CE63",
"#499894",
"#86BCB6",
"#E31A1C",
"#E15759",
"#FF9D9A",
"#CAB2D6",
"#79706E",
"#A1D99B",
"#41AB5D",
"#006D2C",
"#00441B"))+
  theme_bw()+
  ylim(0,1)+
  ylab("Relative abundance")+
  theme(axis.title.y = element_text(size =14))+
  theme(axis.title.x = element_blank())+
  theme(axis.text = element_text(size = 14))+
  theme(axis.text.x = element_blank())+
  theme(axis.text.y = element_text(size = 12))+
  theme(axis.ticks.x = element_blank())+
  theme(strip.text.x = element_text(size = 12))+ 
  theme(strip.text.y = element_text(size = 14))+
  theme(legend.title = element_text(size = 12))+
  theme(legend.text = element_text(size = 10))+
  labs(fill = "Genus");b
  
# mean abundance by taxa, by some metadata:
abun.summary <- ps.melt_agg %>% 
  group_by(aggTaxo, practice) %>% 
  summarise(mean = mean(Abundance))%>%
 pivot_wider(names_from = practice, values_from = mean, names_prefix = "mean_");abun.summary

sum(abun.summary$mean_Conventional)
sum(abun.summary$mean_Organic)

```

## Figure 2B (Diversity)

```{r}
# Estimate Shannon diversity
shann9 <- estimate_richness(sub9, measures = "Shannon")

meta.flower <- as(sample_data(sub9), "data.frame")

# Add alpha diversity by matching rownames
meta.flower$alphadiv <- shann9[rownames(meta.flower), "Shannon"]

# Perform Shapiro-Wilk test for normality
meta.flower %>%
  shapiro_test(alphadiv) # Not normal

wilcox.test(alphadiv ~ practice, data = meta.flower,
                   exact = FALSE)

meta.flower %>%
  kruskal_test (alphadiv ~ practice) # SOME GROUPS ARE DIFFERENT

stat.diversity.flower <- meta.flower %>%
  dunn_test (alphadiv ~ practice, p.adjust.method = "bonferroni");stat.diversity.flower # HERE WE SHOW WHICH GROUPS ARE DIFFERENT 

stat.test.flower <- stat.diversity.flower %>% add_xy_position(x = "practice") 

plot.diversity.flower <- ggplot(meta.flower, aes(practice, alphadiv, fill = practice))+ # What we want to plot
  theme_bw()+ # General style of the plot (black & white)
  geom_rain() +
  # Then rain (points)
  #geom_jitter(width = 0.1)+
  geom_pwc(method = "wilcox_test", label = "p.adj.signif")+
  #stat_pvalue_manual(stat.test.flower, y.position = 5.5,step.increase = 0.1, hide.ns = T)+
  scale_fill_manual(name = "Practice", values = c("#F28E2B", "#499894"))+ # Colors according to the cultivar
  # Seperate the plot according to the site and cultivar
  #facet_grid(cols = vars(time))+ 
  guides(alpha = "none")+ # Remove size legend
  #theme(legend.position="none")+ # Remove legend
  theme(plot.title = element_text(size =16))+# Plot title
  theme(axis.title.x = element_blank())+ # Hide axis title
  ylab("Shannon Index")+ # Y axis labels
  ylim(2.5,5.3)+ # y axis scale
  theme(axis.title.y = element_text(size =14))+ # Axis text
  theme(axis.text = element_text(size = 12))+ # Axis text
  theme(strip.text.x = element_text(size = 16))+ #Axis text
  theme(strip.text.y = element_text(size = 16))+
  theme(legend.position = "none");plot.diversity.flower
```

## Patchwork
```{r}
((plot9/plot.diversity.flower) | b )+
  plot_annotation(tag_levels = 'A')+
  plot_layout(widths = c(2,1))&
  theme(plot.tag = element_text(face = 'bold'))


```


# FIGURE 2 (PCoAs)
Plot numbers correspond to the subset numbers

## Plot 1 (All leaf) 
Plot numbers correspond to the subset numbers

```{r}
# Color by practice (FIGURE 2A)

# Pipe from pcoa dataframe
(plot1B <- pcoa.df.1 %>% 
  # Call ggplot for the following aesthetics
  ggplot(aes(x = PCo1, y = PCo2, colour = practice, shape = time, fill = practice, size = time)) +
  # Plot point
  geom_point(size = 2.5) +
  # Set the theme
  theme_bw()+
  # Add 95% confidence interval ellipses
  stat_ellipse(level=0.95, geom = "polygon",alpha = 1/6, aes(group = practice), color = "black")+
  # Change x and y labs to the appropriate eigen values
   labs(x = paste("PCo1:", 100*eig1[1], "%"),
       y = paste("PCo2:", 100*eig1[2], "%"))+
  # Set the points contour color to black
  scale_color_manual(values= c("black","black","black","black","black","black"))+
  # Set the pints shape
  scale_shape_manual(name = "Time", values = c(21,22,24))+
  # Set the points size
  scale_size_manual(values=c(3,3,3))+ 
  # Set point filling color
  scale_fill_manual(name = "Practices", values = c("#F28E2B", "#499894"))+
  # Adjust legend parameters
  theme(legend.position = c(1,1),
        legend.justification = c(1,1),
        legend.background = element_rect(fill="white",
                                  size=0.5, linetype="solid", 
                                  colour ="black"),
        axis.title = element_text(size = 16))+
  # Change shape legend
  guides(shape = guide_legend(override.aes = list(size=5)))+
  # Change fill legend
  guides(fill = guide_legend(override.aes = list(shape = 22, size=5)))+
  # Remove size legend
  guides(size = "none")+
  # Remove contour color legend
  guides(color = "none"))

# Color by site

#(plot1 <- pcoa.df.1 %>% 
#  ggplot(aes(x = PCo1, y = PCo2, colour = code, shape = time, fill = code, size = time)) +
# geom_point(size = 2.5) +
# theme_bw()+
#  stat_ellipse(level=0.95, geom = "polygon",alpha = 1/6, aes(group = practice), color = "black")+
#  labs(x = paste("PCo1:", 100*eig1[1], "%"),
#       y = paste("PCo2:", 100*eig1[2], "%"))+
#  scale_color_manual(values= c("black","black","black","black","black","black"))+
#  scale_shape_manual(name = "Time", values = c(21,22,24))+
#  scale_size_manual(values=c(3,3,3))+ 
#  scale_fill_manual(name = "Sites", values = c("#E4A804", "#FDC835", "#527798","#95AFC6","#FEE39A","#D7E1EA"))+
#  theme(legend.position = c(0.9,0.3),
#        legend.background = element_rect(fill="white",
#                                  size=0.5, linetype="solid", 
#                                  colour ="black"))+
#  guides(shape = guide_legend(override.aes = list(size=5)))+
#  guides(fill = guide_legend(override.aes = list(shape = 22, size=5)))+
#  guides(size = "none")+
#  guides(color = "none"))


```

## Plots 6-7-8 (May-July-August)
```{r}
(plot6 <-pcoa.df.6 %>% 
  ggplot(aes(x = PCo1, y = PCo2, colour = practice, fill = practice, shape = practice)) +
  geom_point(size = 2.5) +
  scale_shape_manual(name = "Practices", values = c(21,21), aes(size = c(3, 0.1)))+
  scale_color_manual(values = c("black", "black"))+
  scale_fill_manual(name = "Practices", values = c("#F28E2B", "#499894"))+
  labs(x = paste("PCo1:", 100*eig6[1], "%"),
       y = paste("PCo2:", 100*eig6[2], "%")) +
  theme_bw()+
   ylim(-2,1.5)+
  xlim(-1.1,1.25)+
  theme(plot.title = element_text(size = 16, hjust = 0.5),
        axis.title = element_text(size = 16),
        legend.position = "none",
        axis.title.x = element_blank())+
  guides(shape = guide_legend(override.aes = list(size=5)))+
  guides(fill = guide_legend(override.aes = list(shape = 22, size=5)))+
  guides(size = "none")+
  guides(color = "none"))


(plot7 <-pcoa.df.7 %>% 
  ggplot(aes(x = PCo1, y = PCo2, colour = practice, fill = practice, shape = practice)) +
  geom_point(size=2.5) +
  scale_shape_manual(name = "Practices", values = c(22,22))+
  scale_color_manual(values = c("black", "black"))+
  scale_fill_manual(name = "Practices", values = c("#F28E2B", "#499894"))+
  labs(x = paste("PCo1:", 100*eig7[1], "%"),
       y = paste("PCo2:", 100*eig7[2], "%")) +
  theme_bw()+
   ylim(-1.1,1.75)+
  xlim(-1,1.1)+
  theme(plot.title = element_text(size = 16, hjust = 0.5),
        axis.title = element_text(size = 16),
        legend.position = "none",
        axis.title.x = element_blank())+
  guides(shape = guide_legend(override.aes = list(size=5)))+
  guides(fill = guide_legend(override.aes = list(shape = 22, size=5)))+
  guides(size = "none")+
  guides(color = "none"))

(plot8 <-pcoa.df.8 %>% 
  ggplot(aes(x = PCo1, y = PCo2, colour = practice, fill = practice, shape = practice)) +
  geom_point(size=2.5) +
  scale_shape_manual(name = "Practices", values = c(24,24))+
  scale_color_manual(values = c("black", "black"))+
  scale_fill_manual(name = "Practices", values = c("#F28E2B", "#499894"))+
  labs(x = paste("PCo1:", 100*eig8[1], "%"),
       y = paste("PCo2:", 100*eig8[2], "%")) +
  theme_bw()+
   ylim(-1.5,1.5)+
  xlim(-1.25,1)+
  theme(plot.title = element_text(size = 16, hjust = 0.5),
        axis.title = element_text(size = 16),
        legend.position = "none",
        axis.title.x = element_blank())+
  guides(shape = guide_legend(override.aes = list(size=5)))+
  guides(fill = guide_legend(override.aes = list(shape = 22, size=5)))+
  guides(size = "none")+
  guides(color = "none"))

plot6+plot7+plot8+
  plot_layout(guides = "collect")
```

## May (shade)
We want to make the plot for each sampling month but we want to highlight only the concentional-organic sites pairs (D1-D1 on one plot and B1-B2 on another plot)
```{r}
# Create a column that tell which site to highlight
# Highlight = D1 and D2
pcoa.df.6 <- pcoa.df.6 %>%
    mutate(highlight = ifelse(code %in% c("D1", "D2"), code, "Other"))
# Highlight2 = B1 and B2
pcoa.df.6 <- pcoa.df.6 %>%
    mutate(highlight2 = ifelse(code %in% c("B1", "B2"), code, "Other"))

# Plot highlight D1 and D2
(plot6B <- ggplot(data = pcoa.df.6, 
          aes(x = PCo1, y = PCo2, color = highlight, fill = highlight, shape = highlight))+
  geom_point(size=2.5)+
  theme_bw()+
    scale_color_manual(values = c("black","black","#E1E1E0"))+
    scale_shape_manual(values = c(21,21,21))+
    # D1 and D2 will have color and the "other" will be gray
    scale_fill_manual(name = "Sites", values = c("#F28E2B", "#499894", "#E1E1E0"))+
    labs(x = paste("PCo1:", 100*eig6[1], "%"),
       y = paste("PCo2:", 100*eig6[2], "%")) +
     ylim(-2,1.5)+
  xlim(-1.1,1.25)+
  theme(plot.title = element_text(size = 16, hjust = 0.5),
        axis.title = element_text(size = 16),
        legend.position = "none")+
  guides(shape = "none")+
  guides(fill = guide_legend(override.aes = list(shape = 22, size=5)))+
  guides(size = "none")+
  guides(color = "none"))

# Plot highlight B1 and B2
(plot6C <- ggplot(data = pcoa.df.6, 
          aes(x = PCo1, y = PCo2, color = highlight2, fill = highlight2, shape = highlight2))+
  geom_point(size=2.5)+
  theme_bw()+
    scale_color_manual(values = c("black","black","#E1E1E0"))+
    scale_shape_manual(values = c(21,21,21))+
   # D1 and D2 will have color and the "other" will be gray
    scale_fill_manual(name = "Sites", values = c("#F28E2B", "#499894", "#E1E1E0"))+
    labs(x = paste("PCo1:", 100*eig6[1], "%"),
       y = paste("PCo2:", 100*eig6[2], "%")) +
   ylim(-2,1.5)+
  xlim(-1.1,1.25)+
  theme(plot.title = element_text(size = 16, hjust = 0.5),
        axis.title = element_text(size = 16),
        legend.position = "none",
        axis.title.x = element_blank())+
  guides(shape = "none")+
  guides(fill = guide_legend(override.aes = list(shape = 22, size=5)))+
  guides(size = "none")+
  guides(color = "none"))

plot6 / plot6B / plot6C
```

## July (shade)
```{r}
# Highlight = D1 and D2
pcoa.df.7 <- pcoa.df.7 %>%
    mutate(highlight = ifelse(code %in% c("D1", "D2"), code, "Other"))
# Highlight2 = B1 and B2
pcoa.df.7 <- pcoa.df.7 %>%
    mutate(highlight2 = ifelse(code %in% c("B1", "B2"), code, "Other"))

# D1 and D2
(plot7B <- ggplot(data = pcoa.df.7, 
          aes(x = PCo1, y = PCo2, color = highlight, fill = highlight, shape = highlight))+
  geom_point(size=2.5)+
  theme_bw()+
    scale_color_manual(values = c("black","black","#E1E1E0"))+
    scale_shape_manual(values = c(22,22,22))+
    scale_fill_manual(name = "Sites", values = c("#F28E2B", "#499894", "#E1E1E0"))+
    labs(x = paste("PCo1:", 100*eig7[1], "%"),
       y = paste("PCo2:", 100*eig7[2], "%")) +
  ylim(-1.1,1.75)+
  xlim(-1,1.1)+
  theme(plot.title = element_text(size = 16, hjust = 0.5),
        axis.title = element_text(size = 16),
        legend.position = "none")+
  guides(shape = "none")+
  guides(fill = guide_legend(override.aes = list(shape = 22, size=5)))+
  guides(size = "none")+
  guides(color = "none"))

# B1 and B2
(plot7C <- ggplot(data = pcoa.df.7, 
          aes(x = PCo1, y = PCo2, color = highlight2, fill = highlight2, shape = highlight2))+
  geom_point(size=2.5)+
  theme_bw()+
    scale_color_manual(values = c("black","black","#E1E1E0"))+
    scale_shape_manual(values = c(22,22,22))+
    scale_fill_manual(name = "Sites", values = c("#F28E2B", "#499894", "#E1E1E0"))+
    labs(x = paste("PCo1:", 100*eig7[1], "%"),
       y = paste("PCo2:", 100*eig7[2], "%")) +
 ylim(-1.1,1.75)+
  xlim(-1,1.1)+
  theme(plot.title = element_text(size = 16, hjust = 0.5),
        axis.title = element_text(size = 16),
        legend.position = "none",
        axis.title.x = element_blank())+
  guides(shape = "none")+
  guides(fill = guide_legend(override.aes = list(shape = 22, size=5)))+
  guides(size = "none")+
  guides(color = "none"))

plot7 / plot7B / plot7C
```

## August (shade)
```{r}
# Highlight = D1 and D2
pcoa.df.8 <- pcoa.df.8 %>%
    mutate(highlight = ifelse(code %in% c("D1", "D2"), code, "Other"))
# Highlight2 = B1 and B2
pcoa.df.8 <- pcoa.df.8 %>%
    mutate(highlight2 = ifelse(code %in% c("B1", "B2"), code, "Other"))

# D1 and D2
(plot8B <- ggplot(data = pcoa.df.8, 
          aes(x = PCo1, y = PCo2, color = highlight, fill = highlight, shape = highlight))+
  geom_point(size=2.5)+
  theme_bw()+
    scale_color_manual(values = c("black","black","#E1E1E0"))+
    scale_shape_manual(values = c(24,24,24))+
    scale_fill_manual(name = "Sites", values = c("#F28E2B", "#499894", "#E1E1E0"))+
    labs(x = paste("PCo1:", 100*eig8[1], "%"),
       y = paste("PCo2:", 100*eig8[2], "%")) +
  ylim(-1.5,1.5)+
  xlim(-1.25,1)+
  theme(plot.title = element_text(size = 16, hjust = 0.5),
        axis.title = element_text(size = 16),
        legend.position = "none")+
  guides(shape = "none")+
  guides(fill = guide_legend(override.aes = list(shape = 22, size=5)))+
  guides(size = "none")+
  guides(color = "none"))

# B1 and B2
(plot8C <- ggplot(data = pcoa.df.8, 
          aes(x = PCo1, y = PCo2, color = highlight2, fill = highlight2, shape = highlight2))+
  geom_point(size=2.5)+
  theme_bw()+
    scale_color_manual(values = c("black","black","#E1E1E0"))+
    scale_shape_manual(values = c(24,24,24))+
    scale_fill_manual(name = "Sites", values = c("#F28E2B", "#499894", "#E1E1E0"))+
    labs(x = paste("PCo1:", 100*eig8[1], "%"),
       y = paste("PCo2:", 100*eig8[2], "%")) +
  ylim(-1.5,1.5)+
  xlim(-1.25,1)+
  theme(plot.title = element_text(size = 16, hjust = 0.5),
        axis.title = element_text(size = 16),
        legend.position = "none",
        axis.title.x = element_blank())+
  guides(shape = "none")+
  guides(fill = guide_legend(override.aes = list(shape = 22, size=5)))+
  guides(size = "none")+
  guides(color = "none"))

plot7 / plot7B / plot7C
```

## Patchwork
```{r}
(plot1B|((plot6 + plot7 + plot8))/
  (plot6C + plot7C +plot8C)/   #B1vsB2
  (plot6B + plot7B +plot8B))+  #D1vsD2
  plot_annotation(tag_levels = 'A')&
  theme(plot.tag = element_text(face = 'bold'))
```

# FIGURE 3 (Abundance)

```{r}


length(which(pcoa.df.1$practice=="Conventional" & pcoa.df.1$time == "May"))
length(which(pcoa.df.1$practice=="Conventional" & pcoa.df.1$time == "July"))
length(which(pcoa.df.1$practice=="Conventional" & pcoa.df.1$time == "August"))

length(which(pcoa.df.1$practice=="Organic" & pcoa.df.1$time == "May"))
length(which(pcoa.df.1$practice=="Organic" & pcoa.df.1$time == "July"))
length(which(pcoa.df.1$practice=="Organic" & pcoa.df.1$time == "August"))


# From a phyloseq object, find the top N abundant species, aggregate
# the others into an "Others" category and produce a bar_plot showing
# the average relative abundance of samples per metadata.

# This code uses relative abundances per sample, otherwise the aggregation
# of abundances is biased by the difference in the number of total sequences 
# per sample. 

topN <- 20 # <<< how many top taxa
taxRank <- 'Genus' # <<< which taxonomic rank 

# Melt the phyloseq object, agglomerate taxonomy and standardize abundances
ps.melt <- sub1 %>% # <<< !! your phyloseq object
  tax_glom(taxRank) %>% # aggregate at desired taxrank
  transform_sample_counts(function(x) x/sum(x)) %>%  # normalise counts to 1 by sample
  psmelt %>% # melt the object in a single (massive) table
  select(!!sym(taxRank), Abundance, # psmelt creates an Abundance variable
         practice, time, Sample) # <<< !! sample data variables you will need

# Change "Dothidotthiaceae_gen_Incertae_sedis" name
ps.melt$Genus[ps.melt$Genus == "Dothidotthiaceae_gen_Incertae_sedis"] <- "Dothidotthiaceae*"

# Create a taxon -> taxon group conversion table
taxonomie_agregee <- ps.melt %>% 
  group_by(!!sym(taxRank)) %>% # mean relative abundance by taxRank:
  summarise(sum_relab = mean(Abundance)) %>% 
  arrange(desc(sum_relab)) %>%          # most abundant first 
  mutate(aggTaxo = as.factor(case_when( # new aggregated taxonomy variable
    row_number() < topN ~ !!sym(taxRank),        # N-1 first keep their taxonomy
    row_number() >= topN ~ 'Others'))) %>% # 'Others' for every other taxa
  select(-sum_relab) # no need for this

# Reorder the vector so that 'Others' is first in plots
taxLvl <- taxonomie_agregee %$% aggTaxo %>% 
  setdiff(., 'Others') %>% # remove Others
  rev()%>%
  c('Others',.) # put Others first 

# add the aggregated taxonomy variable to the raw data
ps.melt_agg <- left_join(ps.melt, taxonomie_agregee, 
                         by = taxRank) %>% 
  mutate(aggTaxo = factor(aggTaxo, levels = taxLvl))%>% # reorder factor levels
  group_by(aggTaxo, practice, time, Sample) %>% # sum all Others into one by sample
  summarise(Abundance = sum(Abundance)) 
 

# simple stacked barplot :
c <- ps.melt_agg %>% 
  ggplot(aes(x = 1, y = Abundance, fill = aggTaxo)) +
  geom_bar(stat = 'identity', 
           position = 'fill')+
  facet_nested(~practice+time)+
  scale_fill_manual(values=c(
"#A6A6A9",
"#499894",
"black",
"#A0CBE8",
"darkblue",
"darkorange3",
"#E15759",
"#497894",
"#79706E",
"#CAB2D6",
"#00441B",
"#86BCB6",
"#F28E2B",
"#244154",
"yellow3",
"#41AB5D",
"#FF9D9A",
"#A1D99B",
"purple4",
"#006D2C"))+
  theme_bw()+
  ylim(0,1)+
  ylab("Relative abundance")+
  theme(axis.title.y = element_text(size =16))+
  theme(axis.title.x = element_blank())+
  theme(axis.text = element_text(size = 16))+
  theme(axis.text.x = element_blank())+
  theme(axis.text.y = element_text(size = 12))+
  theme(axis.ticks.x = element_blank())+
  theme(strip.text.x = element_text(size = 14))+ 
  theme(strip.text.y = element_text(size = 14))+
  theme(legend.title = element_text(size = 16))+
  theme(legend.text = element_text(size = 10))+
  labs(fill = "Genus");c
  
# mean abundance by taxa, by some metadata:
abun.summary <- ps.melt_agg %>% 
  group_by(aggTaxo, practice, time) %>% 
  summarise(mean = mean(Abundance))%>%
 pivot_wider(names_from = practice, values_from = mean, names_prefix = "mean_");abun.summary


#others <- ps.melt_agg[which(ps.melt_agg$aggTaxo == "Others"),]
#other.summ <- others %>% 
#  group_by(aggTaxo, practice, time) %>% 
#  summarise(sum = sum(Abundance))%>%
# pivot_wider(names_from = practice, values_from = sum, names_prefix = "sum_");other.summ
#other.summ/table(meta.ABCD$time, meta.ABCD$practice)
```




# FIGURE 4 (DIVERSITY)
## Figure 4B
```{r}
# Estimate Shannon diversity from all leaf (all time, all cultivar)
shann1 <- estimate_richness(sub1, measures = "Shannon")
# Create meta data frame
meta.leaf <- as(sample_data(sub1), "data.frame")
# Add alpha diversity by matching rownames
meta.leaf$alphadiv <- shann1[rownames(meta.leaf), "Shannon"]


length(which(meta.leaf$practice=="Organic" & meta.leaf$time == "May"))


54# Test normality for each group (time)
meta.leaf %>%
  group_by(time) %>%
  shapiro_test (alphadiv) # Not normal

# Test if some group are different
meta.leaf %>%
  group_by(time) %>%
  kruskal_test (alphadiv ~ practice) 

# Test which group are different (post-hoc test)
# Store results into an object
stat.diversity.leaf <- meta.leaf %>%
  group_by(time) %>%
  dunn_test (alphadiv ~ practice, p.adjust.method = "bonferroni");stat.diversity.leaf

# Find x.y positions to plot the statistical results
stat.test.leaf <- stat.diversity.leaf %>% add_xy_position(x = "practice")

# Make the plot
plot.diversity <- ggplot(meta.leaf, aes(practice, alphadiv))+ # What we want to plot
  theme_bw()+ # General style of the plot (black & white)
  geom_violin(aes(fill = practice), alpha =0.5, position = position_identity()) +
  geom_boxplot(aes(fill = practice), alpha = 1, width = 0.2, position = position_identity(), outliers = FALSE)+
  scale_fill_manual(name = "Practice", values = c("#F28E2B", "#499894"))+ # Colors according to the cultivar
  # Seperate the plot according to the site and cultivar
  facet_wrap(~time)+
  guides(alpha = "none")+ # Remove size legend
  theme(legend.position="none")+ # Remove legend
  theme(plot.title = element_text(size =16))+# Plot title
  theme(axis.title.x = element_blank())+ # Hide axis title
  ylab("")+ # Y axis labels
  ylim(0,7.5)+ # y axis scale
  theme(axis.title.y = element_text(size =16))+ 
  theme(axis.text.x = element_blank())+ 
  theme(axis.ticks.x = element_blank())+
  theme(axis.text = element_text(size = 16))+ 
  theme(strip.text.x = element_text(size = 16))+ 
  theme(strip.text.y = element_text(size = 16))+
  # Add statistical results on the plot
  stat_pvalue_manual(stat.test.leaf, y.position = 6.5, step.group.by = "time", step.increase = 0.1, hide.ns = T);plot.diversity
```

## Figure 4A
```{r}
meta.leaf %>%
  group_by(code) %>%
  shapiro_test (alphadiv) # SOME ARE NOT NORMAL

meta.leaf %>%
  group_by(code) %>%
  kruskal_test (alphadiv ~ time) # SOME GROUPS ARE DIFFERENT

stat.diversity.all <- meta.leaf%>%
  group_by(code) %>%
  dunn_test (alphadiv ~ time, p.adjust.method = "bonferroni");stat.diversity.all  # HERE WE SHOW WHICH GROUPS ARE DIFFERENT 

stat.test.all <- stat.diversity.all %>% add_xy_position(x = "time")

plot.diversity2 <- ggplot(meta.leaf, aes(time, alphadiv))+ # What we want to plot
  theme_bw()+ # General style of the plot (black & white)
  geom_violin(aes(fill = practice),alpha = 0.5,position = position_identity()) +
  geom_boxplot(aes(fill = practice), alpha = 1, width = 0.2, position = position_identity(), outliers = FALSE)+
  scale_fill_manual(name = "Practice", values = c("#F28E2B", "#499894"))+ # Colors according to the cultivar
  # Seperate the plot according to the site and cultivar
  facet_grid(cols = vars(code))+ 
  guides(alpha = "none")+ # Remove size legendhttp://127.0.0.1:12599/graphics/plot_zoom_png?width=795&height=879
  theme(legend.position=c(0.999,0.99), legend.justification = c(1,1),
        legend.background = element_rect(fill="white",
                                  size=0.5, linetype="solid", 
                                  colour ="black"))+ 
  theme(plot.title = element_text(size =16))+# Plot title
  theme(axis.title.x = element_blank())+ # Hide axis title
  ylab("Shannon Index")+ # Y axis labels
  ylim(0,7.5)+ # y axis scale
  theme(axis.title.y = element_text(size =16))+ # Axis text
  theme(axis.text = element_text(size = 14))+ # Axis text
  theme(strip.text.x = element_text(size = 16))+ #Axis text
  theme(strip.text.y = element_text(size = 16))+
  stat_pvalue_manual(stat.test.all, step.group.by = "code", y.position = 6.5, step.increase = 0.1, hide.ns = T);plot.diversity2
```

## Figure 4C
```{r}
meta.leaf %>%
  group_by(practice) %>%
  shapiro_test (alphadiv) # SOME ARE NOT NORMAL

meta.leaf %>%
  group_by(practice) %>%
  kruskal_test (alphadiv ~ time) # SOME GROUPS ARE DIFFERENT


stat.diversity <- meta.leaf%>%
  group_by(practice) %>%
  dunn_test (alphadiv ~ time, p.adjust.method = "bonferroni");stat.diversity  # HERE WE SHOW WHICH GROUPS ARE DIFFERENT 

stat.test <- stat.diversity %>% add_xy_position(x = "time")

plot.diversity3 <- ggplot(meta.leaf, aes(time, alphadiv))+ # What we want to plot
  theme_bw()+ # General style of the plot (black & white)
  geom_violin(aes(fill = practice), alpha = 0.5)+
  geom_boxplot(aes(fill = practice), alpha = 1, width = 0.2, position = position_identity(), outliers = FALSE)+
  scale_fill_manual(name = "Practice", values = c("#F28E2B", "#499894"))+ # Colors according to the cultivar
  # Seperate the plot according to the site and cultivar
  facet_grid(cols = vars(practice))+ 
  guides(alpha = "none")+ # Remove size legendhttp://127.0.0.1:12599/graphics/plot_zoom_png?width=795&height=879
  theme(legend.position="none")+ # Remove legend
  theme(plot.title = element_text(size =16))+# Plot title
  theme(axis.title.x = element_blank())+ # Hide axis title
  ylab("Shannon Index")+ # Y axis labels
  ylim(0,7.5)+ # y axis scale
  theme(axis.title.y = element_text(size =16))+ # Axis text
  theme(axis.text = element_text(size = 14))+ # Axis text
  theme(strip.text.x = element_text(size = 16))+ #Axis text
  theme(strip.text.y = element_text(size = 16))+
  stat_pvalue_manual(stat.test, step.group.by = "practice", y.position = 6.5, step.increase = 0.1, hide.ns = T);plot.diversity3
```

## Patchwork
```{r}
plot.diversity2/(plot.diversity3+plot.diversity)+
  plot_annotation(tag_levels = 'A')& 
  theme(plot.tag = element_text(face = "bold", size = 16))
```


# SUPPLEMENTARY FIGURES (HC & SP ONLY)

##Apply functions
```{r}
# All Leaf
app2 <- df.func(sub2)
eig2 <- app2$res1
pcoa.df.2 <- app2$res2
mat2 <- app2$res3
ado2 <- app2$res4
meta2 <- sub2@sam_data
# May
app3 <- func.notime(sub3)
eig3 <- app3$res1
pcoa.df.3 <- app3$res2
ado3 <- app3$res4
# July
app4 <- func.notime(sub4)
eig4 <- app4$res1
pcoa.df.4 <- app4$res2
ado4 <- app4$res4
# August
app5 <- func.notime(sub5)
eig5 <- app5$res1
pcoa.df.5 <- app5$res2
ado5 <- app5$res4

# Flower (HC + SP)
app10 <- func.notime(sub10)
eig10 <- app10$res1
pcoa.df.10 <- app10$res2
mat10 <- app10$res3
ado10 <- app10$res4
meta10 <- sub10@sam_data
```

# Figure S1 (FLOWERS)

```{r}

length(which(pcoa.df.10$practice=="Organic"))
length(which(pcoa.df.10$practice=="Conventional"))

(plot10 <- pcoa.df.10 %>% 
  ggplot(aes(x = PCo1, y = PCo2, colour = practice, shape = code, fill = practice, size = code)) +
  geom_point(size = 2.5) +
  theme_bw()+
  stat_ellipse(level=0.95, geom = "polygon",alpha = 1/6, aes(group = practice))+
  labs(x = paste("PCo1:", 100*eig10[1], "%"),
       y = paste("PCo2:", 100*eig10[2], "%"))+
  scale_color_manual(values= c("black","black"))+
  scale_shape_manual(name = "Sites", values = c(21,22,23,24))+
  scale_size_manual(values=c(3,3,3,3))+ 
  scale_fill_manual(name = "Practices", values = c("#F28E2B", "#499894"))+
  theme(legend.position = c(1,1),
        legend.justification = c(1,1),
        legend.direction = "horizontal",
        legend.background = element_rect(fill="white",
                                  size=0.5, linetype="solid", 
                                  colour ="black"),
        axis.title = element_text(size = 16))+
  guides(shape = guide_legend(override.aes = list(size=3)))+
  guides(fill = guide_legend(override.aes = list(shape = 22, size=3)))+
  guides(size = "none")+
  guides(color = "none"))
```

## (Abundance)
```{r}
# From a phyloseq object, find the top N abundant species, aggregate
# the others into an "Others" category and produce a bar_plot showing
# the average relative abundance of samples per metadata.

# This code uses relative abundances per sample, otherwise the aggregation
# of abundances is biased by the difference in the number of total sequences 
# per sample. 

topN <- 20 # <<< how many top taxa
taxRank <- 'Genus' # <<< which taxonomic rank 

# Melt the phyloseq object, agglomerate taxonomy and standardize abundances
ps.melt <- sub10 %>% # <<< !! your phyloseq object
  tax_glom(taxRank) %>% # aggregate at desired taxrank
  transform_sample_counts(function(x) x/sum(x)) %>%  # normalise counts to 1 by sample
  psmelt %>% # melt the object in a single (massive) table
  select(!!sym(taxRank), Abundance, # psmelt creates an Abundance variable
         practice, Sample) # <<< !! sample data variables you will need

# Change "Dothidotthiaceae_gen_Incertae_sedis" name
ps.melt$Genus[ps.melt$Genus == "Dothidotthiaceae_gen_Incertae_sedis"] <- "Dothidotthiaceae*"

# Create a taxon -> taxon group conversion table
taxonomie_agregee <- ps.melt %>% 
  group_by(!!sym(taxRank)) %>% # mean relative abundance by taxRank:
  summarise(sum_relab = mean(Abundance)) %>% 
  arrange(desc(sum_relab)) %>%          # most abundant first 
  mutate(aggTaxo = as.factor(case_when( # new aggregated taxonomy variable
    row_number() < topN ~ !!sym(taxRank),        # N-1 first keep their taxonomy
    row_number() >= topN ~ 'Others'))) %>% # 'Others' for every other taxa
  select(-sum_relab) # no need for this

# Reorder the vector so that 'Others' is first in plots
taxLvl <- taxonomie_agregee %$% aggTaxo %>% 
  setdiff(., 'Others') %>% # remove Others
  rev() %>%
  c('Others',.) # put Others first 

# add the aggregated taxonomy variable to the raw data
ps.melt_agg <- left_join(ps.melt, taxonomie_agregee, 
                         by = taxRank) %>% 
  mutate(aggTaxo = factor(aggTaxo, levels = taxLvl))%>% # reorder factor levels
  group_by(aggTaxo, practice, Sample) %>% # sum all Others into one by sample
  summarise(Abundance = sum(Abundance)) 

# simple stacked barplot :
barplot10 <- ps.melt_agg %>% 
  ggplot(aes(x = 1, y = Abundance, fill = aggTaxo)) +
  geom_bar(stat = 'identity', 
           position = 'fill')+
  facet_grid(~practice)+
  scale_fill_manual(values=c(
"#A6A6A9",
"#FC8D59",
"cyan",
"yellow",
"purple",
"red4",
"#FC8D59",
"#FFBE7D",
"#86BCB6",
"#499894",
"#FF9D9A",
"#B6992D",
"#41AB5D",
"#E31A1C",
"#E15759",
"#79706E",
"#CAB2D6",
"#A1D99B",
"#006D2C",
"#00441B"))+
  theme_bw()+
  ylim(0,1)+
  ylab("Relative abundance")+
  theme(axis.title.y = element_text(size =14))+
  theme(axis.title.x = element_blank())+
  theme(axis.text = element_text(size = 14))+
  theme(axis.text.x = element_blank())+
  theme(axis.text.y = element_text(size = 12))+
  theme(axis.ticks.x = element_blank())+
  theme(strip.text.x = element_text(size = 12))+ 
  theme(strip.text.y = element_text(size = 14))+
  theme(legend.title = element_text(size = 12))+
  theme(legend.text = element_text(size = 10))+
  labs(fill = "Genus");barplot10
  
# mean abundance by taxa, by some metadata:
#abun.summary <- ps.melt_agg %>% 
#  group_by(aggTaxo, practice) %>% 
#  summarise(mean = mean(Abundance))%>%
# pivot_wider(names_from = practice, values_from = mean, names_prefix = "mean_");abun.summary
```

## (Diversity)

```{r}
# Estimate Shannon diversity
shann10 <- estimate_richness(sub10, measures = "Shannon")

meta.flower.supp <- as(sample_data(sub10), "data.frame")

# Add alpha diversity by matching rownames
meta.flower.supp$alphadiv <- shann10[rownames(meta.flower.supp), "Shannon"]

# Perform Shapiro-Wilk test for normality
meta.flower.supp %>%
  shapiro_test(alphadiv) # Not normal

wilcox.test(alphadiv ~ practice, data = meta.flower,
                   exact = FALSE)

meta.flower.supp %>%
  kruskal_test (alphadiv ~ practice) # SOME GROUPS ARE DIFFERENT

stat.diversity.flower.supp <- meta.flower.supp %>%
  dunn_test (alphadiv ~ practice, p.adjust.method = "bonferroni");stat.diversity.flower.supp # HERE WE SHOW WHICH GROUPS ARE DIFFERENT 

stat.test.flower <- stat.diversity.flower %>% add_xy_position(x = "practice") 

plot.diversity.flower.supp <- ggplot(meta.flower.supp, aes(practice, alphadiv, fill = practice))+ # What we want to plot
  theme_bw()+ # General style of the plot (black & white)
  geom_rain() +
  # Then rain (points)
  #geom_jitter(width = 0.1)+
  geom_pwc(method = "wilcox_test", label = "p.adj.signif")+
  #stat_pvalue_manual(stat.test.flower, y.position = 5.5,step.increase = 0.1, hide.ns = T)+
  scale_fill_manual(name = "Practice", values = c("#F28E2B", "#499894"))+ # Colors according to the cultivar
  # Seperate the plot according to the site and cultivar
  #facet_grid(cols = vars(time))+ 
  guides(alpha = "none")+ # Remove size legend
  #theme(legend.position="none")+ # Remove legend
  theme(plot.title = element_text(size =16))+# Plot title
  theme(axis.title.x = element_blank())+ # Hide axis title
  ylab("Shannon Index")+ # Y axis labels
  #ylim(2.5,5.5)+ # y axis scale
  theme(axis.title.y = element_text(size =14))+ # Axis text
  theme(axis.text = element_text(size = 12))+ # Axis text
  theme(strip.text.x = element_text(size = 16))+ #Axis text
  theme(strip.text.y = element_text(size = 16))+
  theme(legend.position = "none");plot.diversity.flower.supp
```

## Patchwork
```{r}
((plot10/plot.diversity.flower.supp) | barplot10 )+
  plot_annotation(tag_levels = 'A')+
  plot_layout(widths = c(2,1))&
  theme(plot.tag = element_text(face = 'bold'))
```


# Figure S2
PcoA
```{r}

length(which(pcoa.df.2$practice=="Conventional" & pcoa.df.2$time == "May"))
length(which(pcoa.df.2$practice=="Conventional" & pcoa.df.2$time == "July"))
length(which(pcoa.df.2$practice=="Conventional" & pcoa.df.2$time == "August"))

length(which(pcoa.df.2$practice=="Organic" & pcoa.df.2$time == "May"))
length(which(pcoa.df.2$practice=="Organic" & pcoa.df.2$time == "July"))
length(which(pcoa.df.2$practice=="Organic" & pcoa.df.2$time == "August"))



(plot2 <- pcoa.df.2 %>% 
  ggplot(aes(x = PCo1, y = PCo2, colour = practice, shape = time, fill = practice, size = time)) +
  geom_point(size = 2.5) +
  theme_bw()+
  stat_ellipse(level=0.95, geom = "polygon",alpha = 1/6, aes(group = practice), color = "black")+
  labs(x = paste("PCo1:", 100*eig2[1], "%"),
       y = paste("PCo2:", 100*eig2[2], "%"))+
  scale_color_manual(values= c("black","black","black","black","black","black"))+
  scale_shape_manual(name = "Time", values = c(21,22,24))+
  scale_size_manual(values=c(3,3,3))+ 
  scale_fill_manual(name = "Practices", values = c("#F28E2B", "#499894"))+
  theme(legend.position = c(1,1),
        legend.justification = c(1,1),
        legend.background = element_rect(fill="white",
                                  size=0.5, linetype="solid", 
                                  colour ="black"))+
  guides(shape = guide_legend(override.aes = list(size=5)))+
  guides(fill = guide_legend(override.aes = list(shape = 22, size=5)))+
  guides(size = "none")+
  guides(color = "none"))
```

# Figure S3
Abundance
```{r}
# From a phyloseq object, find the top N abundant species, aggregate
# the others into an "Others" category and produce a bar_plot showing
# the average relative abundance of samples per metadata.

# This code uses relative abundances per sample, otherwise the aggregation
# of abundances is biased by the difference in the number of total sequences 
# per sample. 

topN <- 20 # <<< how many top taxa
taxRank <- 'Genus' # <<< which taxonomic rank 

# Melt the phyloseq object, agglomerate taxonomy and standardize abundances
ps.melt <- sub2 %>% # <<< !! your phyloseq object
  tax_glom(taxRank) %>% # aggregate at desired taxrank
  transform_sample_counts(function(x) x/sum(x)) %>%  # normalise counts to 1 by sample
  psmelt %>% # melt the object in a single (massive) table
  select(!!sym(taxRank), Abundance, # psmelt creates an Abundance variable
         practice, time, Sample) # <<< !! sample data variables you will need

ps.melt$Genus[ps.melt$Genus == "Dothidotthiaceae_gen_Incertae_sedis"] <- "Dothidotthiaceae*"

# Create a taxon -> taxon group conversion table
taxonomie_agregee <- ps.melt %>% 
  group_by(!!sym(taxRank)) %>% # mean relative abundance by taxRank:
  summarise(sum_relab = mean(Abundance)) %>% 
  arrange(desc(sum_relab)) %>%          # most abundant first 
  mutate(aggTaxo = as.factor(case_when( # new aggregated taxonomy variable
    row_number() < topN ~ !!sym(taxRank),        # N-1 first keep their taxonomy
    row_number() >= topN ~ 'Others'))) %>% # 'Others' for every other taxa
  select(-sum_relab) # no need for this

# Reorder the vector so that 'Others' is first in plots
taxLvl <- taxonomie_agregee %$% aggTaxo %>% 
  setdiff(., 'Others') %>% # remove Others
  rev()%>%
  c('Others',.) # put Others first 

# add the aggregated taxonomy variable to the raw data
ps.melt_agg <- left_join(ps.melt, taxonomie_agregee, 
                         by = taxRank) %>% 
  mutate(aggTaxo = factor(aggTaxo, levels = taxLvl))%>% # reorder factor levels
  group_by(aggTaxo, practice, time, Sample) %>% # sum all Others into one by sample
  summarise(Abundance = sum(Abundance)) 
 

# simple stacked barplot :
c <- ps.melt_agg %>% 
  ggplot(aes(x = 1, y = Abundance, fill = aggTaxo)) +
  geom_bar(stat = 'identity', 
           position = 'fill')+
  facet_nested(~practice+time)+
  scale_fill_manual(values=c("#A6A6A9",
"purple",
"#497894",
"darkorange3",
"darkblue",
"#499894",
"#E15759",
"#79706E",
"#A0CBE8",
"#CAB2D6" ,
"#00441B",
"#F28E2B",
"#86BCB6",
"#244154",
"yellow3",
"#FF9D9A",
"#41AB5D",
"#A1D99B",
"purple4",
"#006D2C"))+
  theme_bw()+
  ylim(0,1)+
  ylab("Relative abundance")+
  theme(axis.title.y = element_text(size =16))+
  theme(axis.title.x = element_blank())+
  theme(axis.text = element_text(size = 16))+
  theme(axis.text.x = element_blank())+
  theme(axis.text.y = element_text(size = 12))+
  theme(axis.ticks.x = element_blank())+
  theme(strip.text.x = element_text(size = 14))+ 
  theme(strip.text.y = element_text(size = 14))+
  theme(legend.title = element_text(size = 16))+
  theme(legend.text = element_text(size = 10))+
  labs(fill = "Genus");c
  
# mean abundance by taxa, by some metadata:
abun.summary <- ps.melt_agg %>% 
  group_by(aggTaxo, practice, time) %>% 
  summarise(mean = mean(Abundance))%>%
 pivot_wider(names_from = practice, values_from = mean, names_prefix = "mean_");abun.summary


#others <- ps.melt_agg[which(ps.melt_agg$aggTaxo == "Others"),]
#other.summ <- others %>% 
#  group_by(aggTaxo, practice, time) %>% 
#  summarise(sum = sum(Abundance))%>%
# pivot_wider(names_from = practice, values_from = sum, names_prefix = "sum_");other.summ
#other.summ/table(meta.ABCD$time, meta.ABCD$practice)
```

# Figure S4
Diversity
```{r}

length(which(meta.leaf2$code=="D2" & meta.leaf2$time == "May"))
length(which(meta.leaf2$code=="D2" & meta.leaf2$time == "July"))
length(which(meta.leaf2$code=="D2" & meta.leaf2$time == "August"))

length(which(meta.leaf2$practice=="Conventional" & meta.leaf2$time == "May"))
length(which(meta.leaf2$practice=="Conventional" & meta.leaf2$time == "July"))
length(which(meta.leaf2$practice=="Conventional" & meta.leaf2$time == "August"))
length(which(meta.leaf2$practice=="Organic" & meta.leaf2$time == "May"))
length(which(meta.leaf2$practice=="Organic" & meta.leaf2$time == "July"))
length(which(meta.leaf2$practice=="Organic" & meta.leaf2$time == "August"))



# Estimate Shannon diversity
shann2 <- estimate_richness(sub2, measures = "Shannon")

meta.leaf2 <- as(sample_data(sub2), "data.frame")

# Add alpha diversity by matching rownames
meta.leaf2$alphadiv <- shann2[rownames(meta.leaf2), "Shannon"]

meta.leaf2 %>%
  group_by(time) %>%
  shapiro_test (alphadiv) 

meta.leaf2 %>%
  group_by(time) %>%
  kruskal_test (alphadiv ~ practice) 


stat.diversity.leaf2 <- meta.leaf2 %>%
  group_by(time) %>%
  dunn_test (alphadiv ~ practice, p.adjust.method = "bonferroni");stat.diversity.leaf

stat.test.leaf2 <- stat.diversity.leaf2 %>% add_xy_position(x = "practice")

plot.diversity4 <- ggplot(meta.leaf2, aes(practice, alphadiv))+ # What we want to plot
  theme_bw()+ # General style of the plot (black & white)
  geom_violin(aes(fill = practice), alpha =0.5, position = position_identity()) +
  geom_boxplot(aes(fill = practice), alpha = 1, width = 0.2, position = position_identity(), outliers = FALSE)+
  scale_fill_manual(name = "Practice", values = c("#F28E2B", "#499894"))+ # Colors according to the cultivar
  # Seperate the plot according to the site and cultivar
  facet_wrap(~time)+
  guides(alpha = "none")+ # Remove size legend
  theme(legend.position="none")+ # Remove legend
  theme(plot.title = element_text(size =16))+# Plot title
  theme(axis.title.x = element_blank())+ # Hide axis title
  ylab("")+ # Y axis labels
  ylim(0,7.5)+ # y axis scale
  theme(axis.title.y = element_text(size =16))+ 
  theme(axis.text.x = element_blank())+ 
  theme(axis.ticks.x = element_blank())+
  theme(axis.text = element_text(size = 16))+ 
  theme(strip.text.x = element_text(size = 16))+ 
  theme(strip.text.y = element_text(size = 16))+
  # Add statistical results on the plot
  stat_pvalue_manual(stat.test.leaf2, y.position = 6.5, step.group.by = "time", step.increase = 0.1, hide.ns = T);plot.diversity4
```

```{r}
meta.leaf2 %>%
  group_by(code) %>%
  shapiro_test (alphadiv) # SOME ARE NOT NORMAL

meta.leaf2 %>%
  group_by(code) %>%
  kruskal_test (alphadiv ~ time) # SOME GROUPS ARE DIFFERENT


stat.diversity.all2 <- meta.leaf2%>%
  group_by(code) %>%
  dunn_test (alphadiv ~ time, p.adjust.method = "bonferroni");stat.diversity.all  # HERE WE SHOW WHICH GROUPS ARE DIFFERENT 

stat.test.all2 <- stat.diversity.all2 %>% add_xy_position(x = "time")

plot.diversity5 <- ggplot(meta.leaf2, aes(time, alphadiv))+ # What we want to plot
  theme_bw()+ # General style of the plot (black & white)
  geom_violin(aes(fill = practice),alpha = 0.5,position = position_identity()) +
  geom_boxplot(aes(fill = practice), alpha = 1, width = 0.2, position = position_identity(), outliers = FALSE)+
  scale_fill_manual(name = "Practice", values = c("#F28E2B", "#499894"))+ # Colors according to the cultivar
  # Seperate the plot according to the site and cultivar
  facet_grid(cols = vars(code))+ 
  guides(alpha = "none")+ # Remove size legendhttp://127.0.0.1:12599/graphics/plot_zoom_png?width=795&height=879
  theme(legend.position=c(0.999,0.99), legend.justification = c(1,1),
        legend.background = element_rect(fill="white",
                                  size=0.5, linetype="solid", 
                                  colour ="black"))+ 
  theme(plot.title = element_text(size =16))+# Plot title
  theme(axis.title.x = element_blank())+ # Hide axis title
  ylab("Shannon Index")+ # Y axis labels
  ylim(0,7.5)+ # y axis scale
  theme(axis.title.y = element_text(size =16))+ # Axis text
  theme(axis.text = element_text(size = 14))+ # Axis text
  theme(strip.text.x = element_text(size = 16))+ #Axis text
  theme(strip.text.y = element_text(size = 16))+
  stat_pvalue_manual(stat.test.all2, step.group.by = "code", y.position = 6.5, step.increase = 0.1, hide.ns = T);plot.diversity5
```

```{r}
meta.leaf2 %>%
  group_by(practice) %>%
  shapiro_test (alphadiv) # SOME ARE NOT NORMAL

meta.leaf2 %>%
  group_by(practice) %>%
  kruskal_test (alphadiv ~ time) # SOME GROUPS ARE DIFFERENT


stat.diversity2 <- meta.leaf2%>%
  group_by(practice) %>%
  dunn_test (alphadiv ~ time, p.adjust.method = "bonferroni");stat.diversity  # HERE WE SHOW WHICH GROUPS ARE DIFFERENT 

stat.test2 <- stat.diversity2 %>% add_xy_position(x = "time")

plot.diversity6 <- ggplot(meta.leaf2, aes(time, alphadiv))+ # What we want to plot
  theme_bw()+ # General style of the plot (black & white)
  geom_violin(aes(fill = practice), alpha = 0.5)+
  geom_boxplot(aes(fill = practice), alpha = 1, width = 0.2, position = position_identity(), outliers = FALSE)+
  scale_fill_manual(name = "Practice", values = c("#F28E2B", "#499894"))+ # Colors according to the cultivar
  # Seperate the plot according to the site and cultivar
  facet_grid(cols = vars(practice))+ 
  guides(alpha = "none")+ # Remove size legendhttp://127.0.0.1:12599/graphics/plot_zoom_png?width=795&height=879
  theme(legend.position="none")+ # Remove legend
  theme(plot.title = element_text(size =16))+# Plot title
  theme(axis.title.x = element_blank())+ # Hide axis title
  ylab("Shannon Index")+ # Y axis labels
  ylim(0,7.5)+ # y axis scale
  theme(axis.title.y = element_text(size =16))+ # Axis text
  theme(axis.text = element_text(size = 14))+ # Axis text
  theme(strip.text.x = element_text(size = 16))+ #Axis text
  theme(strip.text.y = element_text(size = 16))+
  stat_pvalue_manual(stat.test2, step.group.by = "practice", y.position = 6.5, step.increase = 0.1, hide.ns = T);plot.diversity6
```

```{r}
plot.diversity5/(plot.diversity6+plot.diversity4)+
  plot_annotation(tag_levels = 'A')& 
  theme(plot.tag = element_text(face = "bold", size = 16))
```

# DISPERSION TEST
Table 1
```{r}
as.data.frame(
  anova(
    betadisper(mat9, meta9$practice, type ="centroid")))
as.data.frame(
  anova(
    betadisper(mat9, meta9$cultivar, type ="centroid"))) 
as.data.frame(
  anova(
    betadisper(mat9, meta9$site, type ="centroid")))
```
Table S1
```{r}
as.data.frame(
  anova(
    betadisper(mat10, meta10$practice, type ="centroid")))
as.data.frame(
  anova(
    betadisper(mat10, meta10$cultivar, type ="centroid"))) 
as.data.frame(
  anova(
    betadisper(mat10, meta10$site, type ="centroid")))
```
Table 2A
```{r}
as.data.frame(
  anova(
    betadisper(mat1, meta1$practice, type ="centroid"))) # Non-significant = no difference between groups
as.data.frame(
  anova(
    betadisper(mat1, meta1$time, type ="centroid"))) # Significant = difference between groups
as.data.frame(
  anova(
    betadisper(mat1, meta1$cultivar, type ="centroid"))) 
as.data.frame(
  anova(
    betadisper(mat1, meta1$site, type ="centroid")))
```
Table 2B (MAY)
```{r}
as.data.frame(
  anova(
    betadisper(mat6, meta6$practice, type ="centroid")))
as.data.frame(
  anova(
    betadisper(mat6, meta6$cultivar, type ="centroid")))
as.data.frame(
  anova(
    betadisper(mat6, meta6$site, type ="centroid")))
```
Table 2C (JULY)
```{r}
as.data.frame(
  anova(
    betadisper(mat7, meta7$practice, type ="centroid")))
as.data.frame(
  anova(
    betadisper(mat7, meta7$cultivar, type ="centroid")))
as.data.frame(
  anova(
    betadisper(mat7, meta7$site, type ="centroid")))
```
Table 2D (AUGUST)
```{r}
as.data.frame(
  anova(
    betadisper(mat8, meta8$practice, type ="centroid")))
as.data.frame(
  anova(
    betadisper(mat8, meta8$cultivar, type ="centroid")))
as.data.frame(
  anova(
    betadisper(mat8, meta8$site, type ="centroid")))
```
Table S2 (LEAF HC & SP)
```{r}
as.data.frame(
  anova(
    betadisper(mat2, meta2$practice, type ="centroid")))
as.data.frame(
  anova(
    betadisper(mat2, meta2$time, type ="centroid")))
as.data.frame(
  anova(
    betadisper(mat2, meta2$cultivar, type ="centroid")))
as.data.frame(
  anova(
    betadisper(mat2, meta2$site, type ="centroid")))
```




# ISABELLE's script for shading 
FIGURE4abcd: PCoA facets on ordination showing difference within and at range's end

sub_metadata$score1vst<-scores(vst.blind.Mat.mds)[,1]
sub_metadata$score2vst<-scores(vst.blind.Mat.mds)[,2]

test <- ggplot(data=sub_metadata, aes(score1vst, score2vst))
test+geom_point(data=transform(sub_metadata, Type = NULL),colour = "grey85")+
  geom_point()+xlab("NMDS1")+ylab("NMDS2")+
  stat_ellipse(level=0.95, geom = "polygon", alpha = 1/6, aes(color=Type, fill = Type, linetype=Area))+
  facet_wrap(~Type) + 
  theme_bw() + theme(legend.title = element_text(colour="black", size=18, face="bold"),
                     legend.text = element_text(colour="black", size = 18),
                     axis.title=element_text(face="bold",size="18", color="black"),
                     legend.position="right",
                     plot.title=element_text(face="bold",size=18)) +
  geom_point(data=sub_metadata,aes(color=Type, fill=Type, shape=Area))+
  scale_color_manual(name="Community",
                     values=c("black","black","black","black"))+
  scale_fill_manual(name="Community",
                    values=c("#1b7837","#d73027","#80cdc1","#fdae61"))+
  scale_shape_manual(values=c(21,1))+
  scale_linetype_manual(values=c(2,1))+
  guides(fill=FALSE,color=FALSE,shape=FALSE,linetype=FALSE)



```{r}
"grey",
"#D5AEE6",
"#DE73F4",
"#CD4A9B",
"#9C207B",
"#F78484",
"#E35959",
"#BB4D3C",
"#F5C898",
"#F9B36D",
"#E09B57",
"#F6F199",
"#E6CF59",
"#C1D03A",
"#64D23C",
"#37A346",
"#246B30",
"#43BCCF",
"#3B839E",
"#244154"
```

# COLORS
```{r}
Others              "#A6A6A9"
Genolevuria         "#244154"
Dothidotthia        "#4E79A7" 
Filobasidium        "#497894"
Naganishia          "darkblue"
Podosphaera         "black"
Dothidotthiaceae*   "#A0CBE8"
Taphrina            "#F28E2B"
Paraphoma           "darkorange3"
Neocucurbitaria     "#FC8D59"
Mycosphaerella      "#FFBE7D"
Venturia            "#B6992D"
Starmerella         "#F1CE63"
Vishniacozyma       "yellow3"
Blumeria            "#499894"
Paraconiothyrium    "#86BCB6"
Sclerotinia         "#E31A1C"
                    "red4" 
Gyoerffyella        "#E15759"
Alternaria          "#FF9D9A"
Epicoccum           "#CAB2D6" 
"purple" 
"purple4"
Fomes               "#79706E"
Cladosporium        "#A1D99B"
Didymella           "#41AB5D"
Aureobasidium       "#006D2C"
Ramularia           "#00441B"
```

